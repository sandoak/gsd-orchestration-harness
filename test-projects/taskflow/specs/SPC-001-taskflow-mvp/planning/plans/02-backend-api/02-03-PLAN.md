---
phase: 02-backend-api
plan: 03
type: execute
wave: 2
depends_on: ['02-01']
files_modified:
  - packages/api/tests/tasks.test.ts
  - packages/api/tests/setup.ts
  - packages/api/vitest.config.ts
autonomous: true
must_haves:
  truths:
    - 'Tests run with in-memory database'
    - 'CRUD operations are tested'
    - 'All tests pass'
  artifacts:
    - path: 'packages/api/vitest.config.ts'
      provides: 'Vitest configuration'
    - path: 'packages/api/tests/tasks.test.ts'
      provides: 'Task database tests'
  key_links: []
must_pass:
  - id: tests-pass
    type: tests_pass
    command: pnpm --filter @taskflow/api test
---

<objective>
Create comprehensive tests for the task database operations.

Purpose: Ensure database layer works correctly before integration.
Output: Passing test suite for task CRUD operations.
</objective>

<execution_context>
@.harness/skills/workflows/execute-plan.md
@.harness/skills/templates/summary.md
</execution_context>

<context>
@specs/SPC-001-taskflow-mvp/SPEC.md
@specs/SPC-001-taskflow-mvp/execution/phases/02-backend-api/02-01-SUMMARY.md
@packages/api/src/db/schema.ts

**Testing approach:**

- Use in-memory SQLite for tests (:memory:)
- Set up fresh database before each test
- Test all CRUD operations
- Test data validation
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vitest configuration</name>
  <files>packages/api/vitest.config.ts, packages/api/tests/setup.ts</files>
  <action>
    1. Create packages/api/vitest.config.ts:
       ```typescript
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         test: {
           globals: true,
           environment: 'node',
           setupFiles: ['./tests/setup.ts'],
           include: ['tests/**/*.test.ts']
         }
       });
       ```

    2. Create packages/api/tests/setup.ts:
       ```typescript
       import { beforeAll, afterAll, beforeEach } from 'vitest';
       import { db, createTables, dropTables } from '../src/db/index.js';

       // Use in-memory database for tests
       process.env.TASKFLOW_DB_PATH = ':memory:';

       beforeAll(() => {
         createTables();
       });

       beforeEach(() => {
         db.exec('DELETE FROM tasks');
       });

       afterAll(() => {
         dropTables();
       });
       ```

  </action>
  <verify>
    - ls packages/api/vitest.config.ts packages/api/tests/setup.ts
  </verify>
  <done>
    - Vitest configured for API package
    - Test setup with in-memory database
  </done>
</task>

<task type="auto">
  <name>Task 2: Create task database tests</name>
  <files>packages/api/tests/tasks.test.ts</files>
  <action>
    Create packages/api/tests/tasks.test.ts:

    ```typescript
    import { describe, it, expect, beforeEach } from 'vitest';
    import { db } from '../src/db/index.js';
    import { v4 as uuidv4 } from 'uuid';

    function createTestTask(overrides = {}) {
      const id = uuidv4();
      const now = new Date().toISOString();
      const task = { id, title: 'Test Task', description: null, completed: 0, ...overrides };

      db.prepare(`
        INSERT INTO tasks (id, title, description, completed, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?)
      `).run(task.id, task.title, task.description, task.completed, now, now);

      return { ...task, createdAt: now, updatedAt: now };
    }

    describe('Tasks Database Operations', () => {
      describe('CREATE', () => {
        it('should insert a new task', () => {
          const id = uuidv4();
          const now = new Date().toISOString();

          db.prepare(`
            INSERT INTO tasks (id, title, description, completed, created_at, updated_at)
            VALUES (?, ?, ?, 0, ?, ?)
          `).run(id, 'New Task', 'Description', now, now);

          const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(id);
          expect(task).toBeDefined();
          expect(task.title).toBe('New Task');
        });
      });

      describe('READ', () => {
        it('should fetch all tasks', () => {
          createTestTask({ title: 'Task 1' });
          createTestTask({ title: 'Task 2' });

          const tasks = db.prepare('SELECT * FROM tasks').all();
          expect(tasks).toHaveLength(2);
        });

        it('should return undefined for non-existent task', () => {
          const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get('non-existent');
          expect(task).toBeUndefined();
        });
      });

      describe('UPDATE', () => {
        it('should update task title', () => {
          const created = createTestTask({ title: 'Original' });

          db.prepare('UPDATE tasks SET title = ? WHERE id = ?').run('Updated', created.id);

          const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(created.id);
          expect(task.title).toBe('Updated');
        });

        it('should update task completion status', () => {
          const created = createTestTask({ completed: 0 });

          db.prepare('UPDATE tasks SET completed = 1 WHERE id = ?').run(created.id);

          const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(created.id);
          expect(task.completed).toBe(1);
        });
      });

      describe('DELETE', () => {
        it('should delete a task', () => {
          const created = createTestTask();

          const result = db.prepare('DELETE FROM tasks WHERE id = ?').run(created.id);
          expect(result.changes).toBe(1);

          const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(created.id);
          expect(task).toBeUndefined();
        });
      });

      describe('Data Validation', () => {
        it('should enforce NOT NULL on title', () => {
          expect(() => {
            db.prepare('INSERT INTO tasks (id, title) VALUES (?, ?)').run(uuidv4(), null);
          }).toThrow();
        });
      });
    });
    ```

  </action>
  <verify>
    - pnpm --filter @taskflow/api test
    - All tests pass
  </verify>
  <done>
    - CREATE tests pass
    - READ tests pass
    - UPDATE tests pass
    - DELETE tests pass
    - Validation tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] packages/api/vitest.config.ts exists
- [ ] packages/api/tests/tasks.test.ts exists
- [ ] pnpm --filter @taskflow/api test passes
</verification>

<success_criteria>

- All database operations tested
- Tests use in-memory database
- All tests pass
  </success_criteria>

<output>
After completion, create `specs/SPC-001-taskflow-mvp/execution/phases/02-backend-api/02-03-SUMMARY.md`
</output>
