---
phase: 02-backend-api
plan: 02
type: execute
wave: 2
depends_on: ['02-01']
files_modified:
  - packages/api/src/routes/tasks.ts
  - packages/api/src/index.ts
autonomous: true
must_haves:
  truths:
    - 'GET /api/tasks returns task list'
    - 'POST /api/tasks creates new task'
    - 'PATCH /api/tasks/:id updates task'
    - 'DELETE /api/tasks/:id removes task'
  artifacts:
    - path: 'packages/api/src/routes/tasks.ts'
      provides: 'Task CRUD endpoints'
      exports: ['default']
  key_links:
    - from: 'packages/api/src/index.ts'
      to: 'packages/api/src/routes/tasks.ts'
      via: 'app.use("/api/tasks", taskRoutes)'
    - from: 'packages/api/src/routes/tasks.ts'
      to: 'packages/api/src/db/index.ts'
      via: 'import { db }'
must_pass:
  - id: file-exists-task-routes
    type: file_exists
    path: packages/api/src/routes/tasks.ts
  - id: api-get-tasks
    type: api_response
    method: GET
    url: /api/tasks
    expects:
      status: 200
  - id: api-create-task
    type: api_response
    method: POST
    url: /api/tasks
    body: { 'title': 'Test task' }
    expects:
      status: 201
api_base_url: 'http://localhost:3001'
---

<objective>
Create REST API endpoints for CRUD operations on tasks.

Purpose: Provide the API that the frontend will consume for task management.
Output: Working task endpoints with proper status codes and error handling.
</objective>

<execution_context>
@.harness/skills/workflows/execute-plan.md
@.harness/skills/templates/summary.md
</execution_context>

<context>
@specs/SPC-001-taskflow-mvp/SPEC.md
@specs/SPC-001-taskflow-mvp/execution/phases/02-backend-api/02-01-SUMMARY.md
@packages/shared/src/types.ts

**Endpoints to create:**

- GET /api/tasks - List all tasks
- GET /api/tasks/:id - Get single task
- POST /api/tasks - Create task (returns 201)
- PATCH /api/tasks/:id - Update task
- DELETE /api/tasks/:id - Delete task
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create task routes</name>
  <files>packages/api/src/routes/tasks.ts</files>
  <action>
    Create packages/api/src/routes/tasks.ts with:

    ```typescript
    import { Router, Request, Response } from 'express';
    import { v4 as uuidv4 } from 'uuid';
    import { db } from '../db/index.js';
    import type { Task, CreateTaskInput, UpdateTaskInput, ApiResponse } from '@taskflow/shared';

    const router = Router();

    // GET /api/tasks - List all tasks
    router.get('/', (_req: Request, res: Response<ApiResponse<Task[]>>) => {
      try {
        const tasks = db.prepare(`
          SELECT id, title, description, completed,
                 created_at as createdAt, updated_at as updatedAt
          FROM tasks ORDER BY created_at DESC
        `).all() as Task[];

        const formattedTasks = tasks.map(task => ({
          ...task,
          completed: Boolean(task.completed)
        }));

        res.json({ data: formattedTasks });
      } catch (error) {
        res.status(500).json({ data: [], error: 'Failed to fetch tasks' });
      }
    });

    // GET /api/tasks/:id - Get single task
    router.get('/:id', (req: Request, res: Response<ApiResponse<Task | null>>) => {
      // Implementation...
    });

    // POST /api/tasks - Create task
    router.post('/', (req: Request<{}, {}, CreateTaskInput>, res: Response<ApiResponse<Task>>) => {
      // Validate title, generate UUID, insert, return 201
    });

    // PATCH /api/tasks/:id - Update task
    router.patch('/:id', (req: Request<{ id: string }, {}, UpdateTaskInput>, res: Response) => {
      // Check exists, build update query, return updated task
    });

    // DELETE /api/tasks/:id - Delete task
    router.delete('/:id', (req: Request, res: Response) => {
      // Delete and return { deleted: true } or 404
    });

    export default router;
    ```

    Include proper error handling:
    - 400 for missing title on POST
    - 404 for not found on GET/:id, PATCH, DELETE
    - 500 for database errors

  </action>
  <verify>
    - ls packages/api/src/routes/tasks.ts
    - grep "router.get\|router.post\|router.patch\|router.delete" packages/api/src/routes/tasks.ts
  </verify>
  <done>
    - All CRUD endpoints created
    - Proper status codes
    - Error handling in place
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire routes to Express app</name>
  <files>packages/api/src/index.ts</files>
  <action>
    Update packages/api/src/index.ts:

    1. Add import at top:
       ```typescript
       import taskRoutes from './routes/tasks.js';
       ```

    2. Replace placeholder GET /api/tasks with:
       ```typescript
       // Task routes
       app.use('/api/tasks', taskRoutes);
       ```

    3. Remove the old placeholder route.

  </action>
  <verify>
    - grep "app.use.*taskRoutes" packages/api/src/index.ts
    - pnpm --filter @taskflow/api build
  </verify>
  <done>
    - Task routes mounted at /api/tasks
    - Old placeholder removed
    - Build succeeds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] packages/api/src/routes/tasks.ts has all CRUD endpoints
- [ ] packages/api/src/index.ts mounts taskRoutes
- [ ] GET /api/tasks returns 200 with data array
- [ ] POST /api/tasks returns 201 with created task
</verification>

<success_criteria>

- All five endpoints functional
- Proper HTTP status codes
- Type-safe request/response handling
  </success_criteria>

<output>
After completion, create `specs/SPC-001-taskflow-mvp/execution/phases/02-backend-api/02-02-SUMMARY.md`
</output>
