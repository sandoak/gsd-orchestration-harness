---
phase: 02-backend-api
plan: 01
type: execute
wave: 1
depends_on: ['01-02']
files_modified:
  - packages/api/src/db/connection.ts
  - packages/api/src/db/schema.ts
  - packages/api/src/db/index.ts
  - packages/api/src/index.ts
autonomous: true
credentials_needed:
  - service: sqlite
    envVars: ['TASKFLOW_DB_PATH']
    reason: 'SQLite database path for TaskFlow task storage'
    context: 'development'
must_haves:
  truths:
    - 'Database connection is established'
    - 'Tasks table is created'
    - 'Database initializes on server start'
  artifacts:
    - path: 'packages/api/src/db/connection.ts'
      provides: 'SQLite database connection'
    - path: 'packages/api/src/db/schema.ts'
      provides: 'Database schema creation'
      exports: ['createTables']
  key_links:
    - from: 'packages/api/src/index.ts'
      to: 'packages/api/src/db/index.ts'
      via: 'import and initialization'
must_pass:
  - id: file-exists-db-connection
    type: file_exists
    path: packages/api/src/db/connection.ts
  - id: file-exists-db-schema
    type: file_exists
    path: packages/api/src/db/schema.ts
---

<objective>
Create the SQLite database connection and schema for task storage. This plan tests the credential lookup flow.

Purpose: Establish database layer that task endpoints will use.
Output: Working database connection with tasks table.
</objective>

<execution_context>
@.harness/skills/workflows/execute-plan.md
@.harness/skills/templates/summary.md
</execution_context>

<context>
@specs/SPC-001-taskflow-mvp/SPEC.md
@specs/SPC-001-taskflow-mvp/execution/phases/01-foundation/01-02-SUMMARY.md

**Credentials Test:**
This plan requests `sqlite` credentials to test the harness credential flow:

- Worker sends `credentials_needed` message
- Orchestrator looks up credentials from credential provider
- Worker receives `credentials_provided` response

Even though SQLite is file-based, we test the protocol by requesting the database path.

**Database structure:**

```sql
CREATE TABLE tasks (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  completed INTEGER DEFAULT 0,
  created_at TEXT,
  updated_at TEXT
);
```

</context>

<tasks>

<task type="auto">
  <name>Task 1: Request credentials and create database connection</name>
  <files>packages/api/src/db/connection.ts</files>
  <action>
    **First: Request credentials via harness protocol**

    Before creating files, worker should report:
    ```typescript
    harness_worker_report({
      type: "credentials_needed",
      session_id: "{session-id}",
      payload: {
        phase: 2,
        plan: 1,
        service: "sqlite",
        envVars: ["TASKFLOW_DB_PATH"],
        reason: "SQLite database path for TaskFlow",
        context: "development"
      }
    })
    ```

    Then wait for response:
    ```typescript
    harness_worker_await({ session_id: "{session-id}" })
    ```

    **After credentials received, create connection.ts:**

    ```typescript
    import Database from 'better-sqlite3';
    import path from 'path';
    import fs from 'fs';

    // Database path from credentials or default
    const DB_PATH = process.env.TASKFLOW_DB_PATH || './data/taskflow.db';

    // Ensure data directory exists
    const dbDir = path.dirname(DB_PATH);
    if (!fs.existsSync(dbDir)) {
      fs.mkdirSync(dbDir, { recursive: true });
    }

    // Create database connection
    export const db = new Database(DB_PATH);

    // Enable WAL mode for better concurrent access
    db.pragma('journal_mode = WAL');

    export function initializeDatabase(): void {
      console.log(`Database initialized at: ${DB_PATH}`);
    }

    export function closeDatabase(): void {
      db.close();
    }
    ```

    Avoid: Don't hardcode the database path - use environment variable.

  </action>
  <verify>
    - ls packages/api/src/db/connection.ts
    - grep "TASKFLOW_DB_PATH" packages/api/src/db/connection.ts
  </verify>
  <done>
    - Credential request made via harness protocol
    - Database connection module created
    - WAL mode enabled
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema</name>
  <files>packages/api/src/db/schema.ts, packages/api/src/db/index.ts</files>
  <action>
    1. Create packages/api/src/db/schema.ts:
       ```typescript
       import { db } from './connection.js';

       export function createTables(): void {
         db.exec(`
           CREATE TABLE IF NOT EXISTS tasks (
             id TEXT PRIMARY KEY,
             title TEXT NOT NULL,
             description TEXT,
             completed INTEGER DEFAULT 0,
             created_at TEXT DEFAULT (datetime('now')),
             updated_at TEXT DEFAULT (datetime('now'))
           )
         `);

         db.exec(`
           CREATE INDEX IF NOT EXISTS idx_tasks_completed
           ON tasks(completed)
         `);

         console.log('Database tables created');
       }

       export function dropTables(): void {
         db.exec('DROP TABLE IF EXISTS tasks');
         console.log('Database tables dropped');
       }
       ```

    2. Create packages/api/src/db/index.ts:
       ```typescript
       export { db, initializeDatabase, closeDatabase } from './connection.js';
       export { createTables, dropTables } from './schema.js';
       ```

    3. Update packages/api/src/index.ts to initialize database:
       Add import and call initializeDatabase() and createTables() on startup.

  </action>
  <verify>
    - ls packages/api/src/db/schema.ts packages/api/src/db/index.ts
    - grep "createTables" packages/api/src/index.ts
  </verify>
  <done>
    - Schema with tasks table created
    - Index on completed column
    - Server initializes database on startup
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Credential request was sent via harness_worker_report
- [ ] packages/api/src/db/connection.ts exists
- [ ] packages/api/src/db/schema.ts creates tasks table
- [ ] packages/api/src/index.ts imports and initializes database
</verification>

<success_criteria>

- Credential flow exercised via harness protocol
- Database layer established
- Tasks table ready for CRUD operations
  </success_criteria>

<output>
After completion, create `specs/SPC-001-taskflow-mvp/execution/phases/02-backend-api/02-01-SUMMARY.md`
</output>
