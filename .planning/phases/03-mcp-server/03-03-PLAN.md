---
phase: 03-mcp-server
plan: 03
type: execute
---

<objective>
Implement output and state MCP tools: gsd_get_output, gsd_get_state, gsd_get_checkpoint.

Purpose: Enable Claude Code to retrieve session output and GSD workflow state for orchestration decisions.
Output: Three working MCP tools for output retrieval and basic GSD state inspection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:

@.planning/phases/03-mcp-server/03-01-SUMMARY.md
@.planning/phases/03-mcp-server/03-02-SUMMARY.md

# Core types for GSD state and checkpoints:

@packages/core/src/types/gsd-state.ts
@packages/core/src/types/checkpoint.ts
@packages/core/src/constants.ts

# Session manager API:

@packages/session-manager/src/persistent-session-manager.ts

**Tech stack available:** @modelcontextprotocol/sdk, @gsd/core (GsdState, CheckpointInfo, CHECKPOINT_PATTERNS)

**API Reference:**

- `manager.getOutput(sessionId): string[]` - Get buffered output chunks
- `manager.getSession(sessionId): Session` - Get session with workingDir
- `CHECKPOINT_PATTERNS` - Regex patterns for checkpoint detection

**Important note:** Full GSD state parsing (STATE.md, ROADMAP.md, PLAN.md) will be implemented in Phase 5. This plan implements basic versions that:

- gsd_get_output: Full implementation (straightforward)
- gsd_get_state: Basic file reading with regex extraction (enhanced in Phase 5)
- gsd_get_checkpoint: Pattern matching in output (enhanced in Phase 5 with XML parsing)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Implement gsd_get_output tool</name>
  <files>packages/mcp-server/src/tools/get-output.ts, packages/mcp-server/src/server.ts</files>
  <action>
Implement gsd_get_output tool:

1. src/tools/get-output.ts:
   - Export function registerGetOutputTool(server: McpServer, manager: PersistentSessionManager)
   - Parameters:
     - sessionId: z.string() - Required
     - lines: z.number().int().positive().default(100) - Optional, last N lines
     - since: z.string().datetime().optional() - Optional, output since timestamp
   - Implementation:
     - Get session to verify it exists
     - Call manager.getOutput(sessionId) to get output chunks
     - Join chunks and split by newline
     - Apply lines limit (tail) or since filter
     - Return output as text content
   - Error handling: session not found

2. Update src/server.ts:
   - Import and register tool

Tool name: "gsd_get_output"
</action>
<verify>pnpm -F @gsd/mcp-server build succeeds, tool registered</verify>
<done>gsd_get_output tool returns session output with optional filtering by lines or timestamp</done>
</task>

<task type="auto">
  <name>Task 2: Implement gsd_get_state and gsd_get_checkpoint tools</name>
  <files>packages/mcp-server/src/tools/get-state.ts, packages/mcp-server/src/tools/get-checkpoint.ts, packages/mcp-server/src/server.ts</files>
  <action>
Implement GSD state tools (basic versions for Phase 3):

1. src/tools/get-state.ts - gsd_get_state:
   - Parameters:
     - sessionId: z.string() - Required (to get workingDir)
   - Implementation:
     - Get session to get workingDir
     - Read {workingDir}/.planning/STATE.md if exists
     - Extract using regex:
       - Current phase number from "Phase: X of Y"
       - Current plan number from "Plan: X of Y"
       - Status from "Status:" line
       - Progress percentage if present
     - Read {workingDir}/.planning/ROADMAP.md for phase list
     - Return GsdState-like object (simplified):
       ```typescript
       {
         currentPhase: number,
         currentPlan: number,
         status: string,
         progress: string,
         hasCheckpoint: boolean // from session status
       }
       ```
   - If .planning/ doesn't exist, return error "No GSD project found"

2. src/tools/get-checkpoint.ts - gsd_get_checkpoint:
   - Parameters:
     - sessionId: z.string() - Required
   - Implementation:
     - Get session and check status
     - If status !== 'waiting_checkpoint', return { hasCheckpoint: false }
     - Get recent output (last 50 lines)
     - Use CHECKPOINT_PATTERNS from @gsd/core to detect type
     - Extract basic info with regex:
       - For human-verify: find "CHECKPOINT: human-verify" and surrounding context
       - For decision: find "CHECKPOINT: decision" and options
       - For human-action: find "CHECKPOINT: human-action" and instructions
     - Return CheckpointInfo-like object with type and raw content
   - Note: Full XML parsing for detailed checkpoint info is Phase 5 scope

3. Update src/server.ts:
   - Import and register both tools

Tool names: "gsd_get_state", "gsd_get_checkpoint"
Note: These are MVP implementations. Phase 5 adds full parsing with GSD state file parsers.
</action>
<verify>pnpm -F @gsd/mcp-server build succeeds, all 6 MCP tools registered</verify>
<done>All 6 MCP tools implemented: start_session, list_sessions, end_session, get_output, get_state, get_checkpoint</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm -F @gsd/mcp-server build` succeeds without errors
- [ ] All 6 tools registered: gsd_start_session, gsd_list_sessions, gsd_end_session, gsd_get_output, gsd_get_state, gsd_get_checkpoint
- [ ] gsd_get_output returns session output correctly
- [ ] gsd_get_state reads STATE.md and extracts basic info
- [ ] gsd_get_checkpoint detects checkpoint type from output
- [ ] Error handling covers: session not found, no GSD project
</verification>

<success_criteria>

- All 6 MCP tools implemented and working
- Phase 3: MCP Server complete
- Tools ready for Claude Code integration testing
- Foundation ready for Phase 5 enhanced parsing
  </success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-server/03-03-SUMMARY.md`

This is the final plan in Phase 3. Summary should include:

- Phase 3 complete status
- All 6 tools implemented
- Next: Phase 4 (Web Dashboard) or Phase 5 (GSD Integration)
  </output>
