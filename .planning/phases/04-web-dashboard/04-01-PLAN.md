---
phase: 04-web-dashboard
plan: 01
type: execute
---

<objective>
Create web-server package with Fastify HTTP server and WebSocket for real-time session streaming.

Purpose: Enable browser-based dashboard to receive live session events from the harness.
Output: Working web-server package that streams SessionEvents via WebSocket.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (Phase 2 provides session events):

@.planning/phases/02-session-management/02-03-SUMMARY.md

# Existing packages to reference:

@packages/core/src/types/events.ts
@packages/session-manager/src/index.ts
@packages/session-manager/src/persistent-session-manager.ts

**Tech stack available:** pnpm workspaces, TypeScript strict mode, @gsd/core types, @gsd/session-manager
**Established patterns:** Composite TypeScript projects, EventEmitter for typed events, dependency injection
**Constraining decisions:**

- [02-03]: PersistentSessionManager emits typed SessionEvents
- [01-01]: Use @gsd/\* path aliases for workspace imports
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create web-server package with Fastify HTTP server</name>
  <files>packages/web-server/package.json, packages/web-server/tsconfig.json, packages/web-server/src/index.ts, packages/web-server/src/http-server.ts</files>
  <action>
    Create @gsd/web-server package:
    - package.json with fastify ^5.0.0, @fastify/cors ^10.0.0, @fastify/websocket ^11.0.0
    - TypeScript config extending tsconfig.base.json with composite: true
    - http-server.ts with FastifyServer class:
      - Constructor takes port (default 3333)
      - start() method that registers CORS, health endpoint (GET /health)
      - stop() method for graceful shutdown
      - Use fastify.register pattern for plugins
    - index.ts exports FastifyServer class
    - Add package to root tsconfig.json references
    - Do NOT use @fastify/static yet (Phase 6 serves dashboard build)
  </action>
  <verify>pnpm install && pnpm -r build succeeds, tsc --noEmit passes</verify>
  <done>Package compiles, GET /health returns { status: 'ok' }</done>
</task>

<task type="auto">
  <name>Task 2: Add WebSocket server with session event broadcasting</name>
  <files>packages/web-server/src/ws-server.ts, packages/web-server/src/types.ts</files>
  <action>
    Add WebSocket support to FastifyServer:
    - types.ts: Define WebSocket message types (SessionEventMessage extends SessionEvent with 'event' wrapper type)
    - ws-server.ts: Create WsServer class that:
      - Registers @fastify/websocket on /ws path
      - Maintains Set of active connections
      - broadcast(event: SessionEvent) method sends JSON to all clients
      - Handles connection/disconnection (add/remove from Set)
      - Send initial state on connect (list of current sessions)
    - Integrate WsServer into FastifyServer (composition, not inheritance)
    - Export WsServer and message types from index.ts
    - Message format: { type: 'session:*', ...eventData } (pass through SessionEvent structure)
  </action>
  <verify>Build passes, can instantiate server without PersistentSessionManager wired yet</verify>
  <done>WebSocket endpoint at ws://localhost:3333/ws accepts connections, broadcasts work</done>
</task>

<task type="auto">
  <name>Task 3: Wire PersistentSessionManager events to WebSocket broadcast</name>
  <files>packages/web-server/src/harness-server.ts, packages/web-server/src/index.ts</files>
  <action>
    Create HarnessServer as the integrated entry point:
    - harness-server.ts: HarnessServer class that:
      - Takes PersistentSessionManager in constructor (dependency injection)
      - Creates internal FastifyServer
      - Subscribes to all manager events (started, output, checkpoint, completed, failed, recovery:complete)
      - Forwards events to WsServer.broadcast()
      - start()/stop() methods delegate to FastifyServer
      - Adds GET /api/sessions endpoint returning manager.listSessions()
    - Update index.ts to export HarnessServer as primary API
    - Keep FastifyServer/WsServer exports for testing flexibility
    - Do NOT create a CLI entry point yet (Phase 6 creates unified harness CLI)
  </action>
  <verify>pnpm -r build passes, TypeScript compiles with no errors</verify>
  <done>HarnessServer accepts PersistentSessionManager, forwards events to WebSocket, /api/sessions endpoint works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm -r build` succeeds without errors
- [ ] `pnpm -r type-check` passes
- [ ] Package exports HarnessServer, FastifyServer, WsServer, types
- [ ] Health endpoint returns JSON response
- [ ] API sessions endpoint compiles with correct types
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Web-server package ready for dashboard integration
  </success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-01-SUMMARY.md`
</output>
