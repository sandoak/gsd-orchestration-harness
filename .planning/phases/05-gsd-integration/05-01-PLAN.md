---
phase: 05-gsd-integration
plan: 01
type: execute
---

<objective>
Create GSD state parser for reading project state from .planning/ files.

Purpose: Enable the harness to understand where a GSD session is in its workflow by parsing STATE.md, ROADMAP.md, and the current PLAN.md file.
Output: GsdStateParser class in @gsd/core with enhanced parsing, integrated into gsd_get_state MCP tool.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gsd-integration/05-CONTEXT.md

# Prior work providing foundation:

@.planning/phases/03-mcp-server/03-03-SUMMARY.md

# Existing code to enhance:

@packages/core/src/types/gsd-state.ts
@packages/mcp-server/src/tools/get-state.ts

**Tech stack available:** TypeScript, @gsd/core types, node:fs
**Established patterns:** Regex-based extraction (MVP in get-state.ts)
**Constraining decisions:**

- [03-03]: MVP regex extraction for STATE.md (this plan enhances it)
- [05-CONTEXT]: State parsing is MVP regex for now (not full AST)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create GsdStateParser class in @gsd/core</name>
  <files>packages/core/src/gsd-state-parser.ts, packages/core/src/index.ts</files>
  <action>
Create GsdStateParser class that parses GSD project state from .planning/ files:

1. **STATE.md parsing** (enhanced from MVP):
   - Current position: Phase X of Y, Plan X of Y
   - Status line: "Phase complete", "In progress", etc.
   - Progress bar: Extract percentage from [███░░░] N%
   - Last activity date
   - Accumulated decisions (from ### Decisions section)
   - Deferred issues (from ### Deferred Issues section)

2. **ROADMAP.md parsing**:
   - Parse phases list with checkboxes: `- [x] **Phase N: Name**` or `- [ ] **Phase N: Name**`
   - Extract phase status (complete/not started) from checkbox
   - Parse plan completion in phase details: `- [x] 01-01: Plan name`

3. **PLAN.md parsing** (current plan):
   - Detect current plan file from STATE.md (Phase X, Plan Y)
   - Parse task count from <tasks> section
   - Detect checkpoint tasks

Return GsdState object with all parsed data.

Implementation notes:

- Use regex patterns, not full AST (per CONTEXT.md)
- Handle missing files gracefully (return partial state)
- Export from @gsd/core index.ts
  </action>
  <verify>TypeScript compiles: `pnpm --filter @gsd/core build`</verify>
  <done>GsdStateParser class exists with parseFromDirectory(workingDir) method returning GsdState</done>
  </task>

<task type="auto">
  <name>Task 2: Integrate GsdStateParser into gsd_get_state tool</name>
  <files>packages/mcp-server/src/tools/get-state.ts</files>
  <action>
Replace inline regex parsing with GsdStateParser:

1. Import GsdStateParser from @gsd/core
2. Replace parseStateFile() function with GsdStateParser.parseFromDirectory()
3. Return full GsdState object instead of BasicGsdState
4. Keep existing error handling pattern

The tool should now return:

- projectName (from PROJECT.md title or directory name)
- currentPhase, currentPlan (numbers)
- phases array with GsdPhase objects (from ROADMAP.md)
- hasCheckpoint flag
- progress percentage
- decisions array (from STATE.md)
- deferredIssues array (from STATE.md)
  </action>
  <verify>Build succeeds: `pnpm build` from root</verify>
  <done>gsd_get_state tool uses GsdStateParser and returns enhanced GsdState</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds without errors
- [ ] @gsd/core exports GsdStateParser
- [ ] gsd_get_state tool returns enhanced state with phases array
</verification>

<success_criteria>

- GsdStateParser created in @gsd/core
- Parser handles STATE.md, ROADMAP.md, and PLAN.md
- gsd_get_state tool returns full GsdState
- Build passes without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/05-gsd-integration/05-01-SUMMARY.md`
</output>
