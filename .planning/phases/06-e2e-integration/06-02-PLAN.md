---
phase: 06-e2e-integration
plan: 02
type: execute
---

<objective>
Create integration tests verifying the full orchestration workflow.

Purpose: Prove all components work together: MCP tools → session spawning → WebSocket streaming → checkpoint detection.
Output: Integration test suite validating end-to-end flows without requiring Claude CLI.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:

@.planning/phases/06-e2e-integration/06-01-SUMMARY.md

# Test patterns from prior phases:

@.planning/phases/02-session-management/02-01-SUMMARY.md
@.planning/phases/02-session-management/02-03-SUMMARY.md

# Key source files:

@packages/harness/src/index.ts
@packages/mcp-server/src/server.ts
@packages/web-server/src/harness-server.ts
@packages/session-manager/src/session-manager.test.ts

**Tech stack available:** vitest, better-sqlite3 (temp DBs), injectable executable
**Established patterns:**

- Integration tests with temp databases (02-03)
- Injectable executable for testing without Claude CLI (02-01)
- Mock shell scripts that output controlled data
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test infrastructure</name>
  <files>packages/harness/vitest.config.ts, packages/harness/src/test-utils.ts</files>
  <action>
Create test infrastructure for harness integration tests:

1. vitest.config.ts with appropriate timeouts for integration tests (longer than unit tests)

2. test-utils.ts providing:
   - createTestHarness(): Creates PersistentSessionManager with temp DB, HarnessServer on random port
   - cleanupTestHarness(): Stops server, closes manager, removes temp DB
   - waitForWebSocket(): Connects to WebSocket and returns promise that resolves on 'open'
   - createMockScript(): Creates temp shell script that outputs controlled data for testing

Pattern from 02-03: Use unique temp database per test to avoid conflicts.
Pattern from 02-01: Use executable option to run mock scripts instead of Claude CLI.
</action>
<verify>pnpm --filter @gsd/harness type-check</verify>
<done>Test utilities exist for creating isolated test harness instances</done>
</task>

<task type="auto">
  <name>Task 2: Write MCP-to-WebSocket integration tests</name>
  <files>packages/harness/src/harness.integration.test.ts</files>
  <action>
Create integration tests verifying:

1. **Session lifecycle via shared manager:**
   - Start session via SessionManager
   - Verify WebSocket receives session:started event
   - Verify WebSocket receives session:output events
   - End session via SessionManager
   - Verify WebSocket receives session:completed event

2. **REST API consistency:**
   - Start session
   - GET /api/sessions returns session
   - Verify session status matches manager state

3. **Multiple sessions:**
   - Start 2 sessions (within MAX_SESSIONS limit)
   - Verify both appear in WebSocket initial state
   - Verify both return from /api/sessions

Use mock executable that:

- Outputs "Hello from session {id}" immediately
- Waits 100ms
- Outputs "Done" and exits

Tests should:

- Create isolated harness per test
- Clean up fully after each test
- Use unique ports to allow parallel execution
  </action>
  <verify>pnpm --filter @gsd/harness test</verify>
  <done>Integration tests pass verifying MCP server and WebSocket share session state</done>
  </task>

<task type="auto">
  <name>Task 3: Add harness test script to root package.json</name>
  <files>package.json, packages/harness/package.json</files>
  <action>
Update packages/harness/package.json with:
- "test": "vitest run"
- "test:watch": "vitest"

Add devDependencies:

- vitest: ^1.0.0
- @types/node: ^20.10.0

Update root package.json:

- "test:integration": "pnpm --filter @gsd/harness test"

This separates integration tests (slower) from unit tests in other packages.
</action>
<verify>
pnpm test:integration runs harness integration tests
pnpm test runs all tests (unit + integration)
</verify>
<done>Integration tests runnable via pnpm test:integration, included in pnpm test</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @gsd/harness test` passes
- [ ] Tests verify session events flow from manager → WebSocket
- [ ] Tests verify REST API reflects manager state
- [ ] Tests clean up temp databases and ports
</verification>

<success_criteria>

- Integration test suite exists in @gsd/harness
- Tests verify shared state between MCP and web components
- Tests use mock executable (no Claude CLI dependency)
- All tests pass and clean up properly
  </success_criteria>

<output>
After completion, create `.planning/phases/06-e2e-integration/06-02-SUMMARY.md`
</output>
