---
phase: 06-e2e-integration
plan: 01
type: execute
---

<objective>
Wire MCP server and web dashboard to share a single PersistentSessionManager instance.

Purpose: Enable the orchestration flow where Claude Code calls MCP tools while humans monitor via the dashboard.
Output: Unified harness entry point with shared session state, npm scripts for startup.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (integration dependencies):

@.planning/phases/03-mcp-server/03-01-SUMMARY.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md
@.planning/phases/05-gsd-integration/05-03-SUMMARY.md

# Key source files:

@packages/mcp-server/src/index.ts
@packages/mcp-server/src/server.ts
@packages/web-server/src/harness-server.ts
@packages/session-manager/src/persistent-session-manager.ts

**Tech stack available:** pnpm workspaces, TypeScript, Fastify 5.x, @modelcontextprotocol/sdk, better-sqlite3
**Established patterns:** Dependency injection for PersistentSessionManager, EventEmitter-based event wiring
**Constraining decisions:**

- [03-01]: GsdMcpServer accepts PersistentSessionManager via constructor
- [04-01]: HarnessServer accepts PersistentSessionManager via constructor options
- [05-03]: sendInput() method enables checkpoint response relay
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified harness entry point</name>
  <files>packages/harness/package.json, packages/harness/tsconfig.json, packages/harness/src/index.ts</files>
  <action>
Create new @gsd/harness package that:
1. Creates a single PersistentSessionManager instance
2. Starts HarnessServer (web + WebSocket) on port 3333
3. Starts GsdMcpServer with the same manager
4. Handles graceful shutdown for both

The entry point should:

- Be executable via `gsd-harness` CLI command
- Log startup messages to stderr (not stdout - MCP uses stdout)
- Wait for both servers to be ready before accepting connections
- Clean up properly on SIGINT/SIGTERM

Dependencies:

- @gsd/mcp-server (workspace:\*)
- @gsd/web-server (workspace:\*)
- @gsd/session-manager (workspace:\*)

Note: Logging must go to stderr because stdout is reserved for MCP JSON-RPC communication.
</action>
<verify>
pnpm install
pnpm -r build
ls packages/harness/dist/index.js exists
</verify>
<done>@gsd/harness package exists with unified entry point that starts both MCP and web servers</done>
</task>

<task type="auto">
  <name>Task 2: Add root npm scripts for harness operation</name>
  <files>package.json, tsconfig.json</files>
  <action>
Add to root package.json scripts:
- "harness:start": "pnpm -r build && node packages/harness/dist/index.js"
- "harness:dev": "pnpm -r build && tsx packages/harness/src/index.ts"
- "dashboard:dev": "pnpm --filter @gsd/dashboard dev" (runs Vite dev server separately)

Update root tsconfig.json to include harness package reference.

These scripts enable:

1. `pnpm harness:start` - Production-like full harness
2. `pnpm harness:dev` - Development with tsx
3. `pnpm dashboard:dev` - Frontend dev separately (connects to harness WebSocket)
   </action>
   <verify>
   pnpm harness:start (verify it starts without error, then Ctrl+C)
   </verify>
   <done>Root npm scripts work, harness starts MCP server and web dashboard on port 3333</done>
   </task>

<task type="auto">
  <name>Task 3: Add MCP server configuration for Claude Code</name>
  <files>mcp-config.json.example</files>
  <action>
Create mcp-config.json.example showing how to configure Claude Code to use the harness:

{
"mcpServers": {
"gsd-harness": {
"command": "node",
"args": ["packages/harness/dist/index.js"],
"cwd": "/path/to/gsd-orchestration-harness"
}
}
}

Include comments explaining:

- The harness must be built first (pnpm build)
- The web dashboard runs alongside MCP server
- Dashboard URL is http://localhost:3333
  </action>
  <verify>cat mcp-config.json.example shows valid JSON with gsd-harness configuration</verify>
  <done>Example MCP configuration file exists for Claude Code integration</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm install` succeeds
- [ ] `pnpm build` builds all packages including harness
- [ ] `pnpm harness:start` launches without error
- [ ] http://localhost:3333 responds (health endpoint)
- [ ] MCP server responds to stdio (can test with echo)
</verification>

<success_criteria>

- @gsd/harness package created and builds
- Unified entry point starts both MCP and web servers
- Single PersistentSessionManager shared between components
- npm scripts provide easy startup
- MCP config example provided
  </success_criteria>

<output>
After completion, create `.planning/phases/06-e2e-integration/06-01-SUMMARY.md`
</output>
